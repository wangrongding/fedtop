# 谁动了我的代码!

下面我将带大家一起，完成一个代码规范校验

没办法，女孩子嘛。。。也不好说什么。  
要是男生，我一定站起来大骂，你真是一个 **小(x)可(x)爱(x)**！

## husky

搞工程化，我们肯定都少不了 `husky`，它能很方便的帮我们阻挡小可爱的进攻，不，是为微我们的项目添加`git hooks`

### 具体方法

首先我们将 `husky` 安装到开发依赖中

```sh
npm i husky -D
# or
yarn add husky -D
```

> ### 注意
>
> 目前我所安装的版本是`husky@7.0.4`,由于`husky@6.0.0` 后做了`breaking change`，所以在`6.0.0`版本之前的那种设置钩子的方法已经不适用了,**这里我们只介绍最新的方式**。

安装完后，我们需要在当前项目中创建一个`.husky`目录并指定该目录为 `git hooks` 所在的目录。

使用以下命令快速创建 👇

```sh
#--no-install 参数表示强制npx使用项目中node_modules目录下的husky依赖包
npx --no-install husky install
```

为了让其他人在此项目中安装依赖后也能自动创建`.husky`目录并指定该目录为 `git hooks` 所在的目录，我们需要在 `package.json` 里面添加一条脚本`"prepare": "husky install"`

使用以下命令快速添加 👇

```sh
npm set-script prepare "husky install"
```

> `prepare` 脚本会在 `npm i`或者其他`yarn or yarn add` 之后自动执行。也就是说当我们安装依赖后会自动执行 `husky install` 命令，从而自动创建`.husky`目录并指定该目录为 `git hooks` 所在的目录。

使用以下命令快速创建 👇

```sh
npx husky add .husky/pre-commit "npm run [你要执行的命令]"
```

完成后可以看到`.husky`目录下新增了一个`pre-commit`文件,其中的内容为 👇
![](https://gitee.com/wangrongding/image-house/raw/master/images/202202102247151.png)

这里我用的是`npm run lint`，这样我们就可以配合 Eslint 的代码校验,来限制不规范代码的提交了

![](https://gitee.com/wangrongding/image-house/raw/master/images/202202102258141.png)  
可以看到，不符合 Eslint 校验规则的代码是没法提交的；

当然，这里的报错问题只是由于缩进不规范引起的，类似这种的问题还有引号，句尾分号，换行符等等...都可以通过 `eslint` 的参数 `--fix`来自动修复，这样就可以在提交前，先将能实现自动修复的简单代码风格问题后 commit。复杂的情况还是要自己去手动处理的。

> 说到换行符，这里我们需要了解的是：在 Windows 上默认的是回车换行（Carriage Return Line Feed, CRLF），然而，在 Linux/MacOS 上则是换行（Line Feed, LF）。

我们可以试一下将原先换行符为`crlf`的文件格式化为换行符为`lf`，或者直接通过 eslint 的--fix 修复为 `lf`后，且不通过 `.gitattributes`文件设置 eol(end of line)而执行`git add .`的情况。

![](https://gitee.com/wangrongding/image-house/raw/master/images/202202110120354.png)

可以看到最终 LF 换行符还是被 CRLF 替换了；

建议大家在项目目录里新建一个`.gitattributes`（主要用于定义每种文件的属性，以方便 git 帮我们统一管理。），设置 eol(end of line)为指定的换行符（lf/crlf），文件内容如下 👇

![](https://gitee.com/wangrongding/image-house/raw/master/images/202202110114810.png)

添加上述文件后，，在`git add`后,所有不是指定换行符的文件都会被自动更换为你指定的换行符，例如我这里指定了`lf`,那么 `git add .` 后，不是以 `lf` 换行的文件都会被成功自动修复为 `lf` 换行，并在终端输出`warning: CRLF will be replaced by LF in xxxx/filename`，如图 👇

![](https://gitee.com/wangrongding/image-house/raw/master/images/202202110149455.png)

`.gitattributes`有很多用处，具体可以查看 👉[gitattributes](https://git-scm.com/docs/gitattributes)

🥰 到这里，一个最简单的代码风格限制方法就已经实现了。

既然做了，就肯定要做一套完整的，且好用的。下面我们来继续完善其他功能 ~

---

## lint-staged

什么是`lint-staged`?顾名思义，借助这个工具只是用来检查 git 暂存区文件的，就是在你`git add file1，2，3...` 后的暂存区文件中运行 `lint` 的一个工具。

毕竟，每次提交一两个文件，却都要 `lint` 所有文件话，是没有必要的，我们只对需要提交的代码进行 `lint`,这样可以减少没必要的时间开销。（如果你每次修改一个文件，都要去 `lint` 所有文件，这个工具对你来说就没有什么意义了 🤐）

### 使用方法

我们将`.husky/pre-commit`中之前写代码改为 👇

```diff
#!/bin/sh
. "$(dirname "$0")/_/husky.sh"
- npm run lint
+ npx --no-install lint-staged
```

然后在 package.json 中添加以下代码,`lint-staged`对象中采用键值对的方式进行配置，键名是你想处理的单个文件或一个文件类型，键值是一个数组，数组中为 lint 时执行的命令组。

```json
{
  "lint-staged": {
    "*.{ts,js,vue}": ["eslint"]
  }
}
```

添加玩上述代码后，我们通过测试，将两个文件的缩进改为不符合规范的情况，然后将其中一个文件暂存后，我们运行`git commit`后发现终端的报错中，只有一个文件的 `lint` 报错信息,另一个文件的报错并没有出现。

![](https://gitee.com/wangrongding/image-house/raw/master/images/202202110219538.png)

## 限制 commit-msg

使用以下命令快速创建 👇

```sh
npx husky add .husky/commit-msg 'npx --no-install commitlint --edit "$1"'
```
